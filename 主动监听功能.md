# 🤖 Webhook 自动监听设置指南

## ✨ 新功能说明

**Bot 会自动监听所有群组/频道的文件消息，无需转发！**

- ✅ Bot 实时监听消息
- ✅ 自动保存文件信息到 D1
- ✅ 知道消息 ID 即可直接下载
- ✅ 完全无副作用，不会在频道留下任何痕迹

## 📋 工作原理

```
┌─────────────────────────────────────┐
│  Telegram 频道/群组                  │
│  (Bot 是管理员)                      │
│                                     │
│  用户发送: 📄 document.pdf          │
└─────────────────────────────────────┘
            ↓
            ↓ Telegram 自动推送
            ↓
┌─────────────────────────────────────┐
│  Cloudflare Worker (Webhook)        │
│                                     │
│  1. 接收消息更新                     │
│  2. 检测到文件                       │
│  3. 提取 file_id                     │
│  4. 获取文件路径                     │
│  5. 加密存储到 D1                    │
└─────────────────────────────────────┘
            ↓
            ↓ 自动保存
            ↓
┌─────────────────────────────────────┐
│  D1 数据库                           │
│                                     │
│  file_key: @myblog/123              │
│  encrypted_data: {...}              │
└─────────────────────────────────────┘
            ↓
            ↓ 用户访问
            ↓
┌─────────────────────────────────────┐
│  https://.../file/@myblog/123       │
│                                     │
│  直接下载！无需转发！               │
└─────────────────────────────────────┘
```

## 🚀 快速设置（3步）

### 步骤 1：确保环境变量已设置

在 Cloudflare Dashboard 检查：

```
✅ ACCESS_PASSWORD = "你的密码"
✅ ENCRYPTION_KEY = "32位密钥"
✅ BOT_TOKEN = "123456:ABC-DEF"
```

### 步骤 2：设置 Webhook

```bash
curl -X POST 'https://tgbotapi.gongzhonghao.dpdns.org/set-webhook' \
  -H 'X-Access-Password: 密码'
```

**成功响应：**
```json
{
  "success": true,
  "message": "Webhook 设置成功！Bot 现在会自动保存所有文件消息",
  "webhook_url": "https://tgbotapi.gongzhonghao.dpdns.org/webhook/BOT_TOKEN(去掉数字）",
  "info": "Bot 会自动监听所有群组/频道的文件消息并保存到数据库"
}
```

### 步骤 3：测试

在你的频道发送一个文件，然后访问：

```
https://tgbotapi.gongzhonghao.dpdns.org/file/@你的频道/消息ID
```

立即下载！✅

## 📝 完整使用流程

### 场景 1：通过 Bot API 上传（推荐）

```bash
# 上传文件
curl -X POST 'https://tgbotapi.gongzhonghao.dpdns.org/bot7722553870:BOT_TOKEN(去掉数字）/sendDocument' \
  -H 'X-Access-Password: 密码' \
  -F 'chat_id=-1001826585339' \
  -F 'document=@file.pdf'

# 返回消息 ID: 281
# 立即可用: https://tgbotapi.gongzhonghao.dpdns.org/file/1826585339/281
```

**Bot 会自动：**
1. 上传文件到 Telegram
2. 接收 Webhook 推送
3. 保存文件信息到 D1
4. 返回下载链接

### 场景 2：手动上传/转发文件

```bash
# 1. 在 Telegram 中手动上传文件到频道（消息 ID: 285）

# 2. Bot 自动接收 Webhook 并保存

# 3. 直接访问下载
https://tgbotapi.gongzhonghao.dpdns.org/file/@myblog/285
```

### 场景 3：历史文件（Webhook 设置前）

对于设置 Webhook 之前的历史文件，使用 API 生成：

```bash
curl -X POST 'https://tgbotapi.gongzhonghao.dpdns.org/add-forwarded-file' \
  -H 'Content-Type: application/json' \
  -H 'X-Access-Password: 密码' \
  -d '{
    "chat_id": "-1001826585339",
    "message_id": 281
  }'
```

## 🔍 验证 Webhook 状态

### 检查 Webhook 是否设置成功

```bash
curl "https://api.telegram.org/bot7722553870:BOT_TOKEN(去掉数字）/getWebhookInfo"
```

**正常响应：**
```json
{
  "ok": true,
  "result": {
    "url": "https://tgbotapi.gongzhonghao.dpdns.org/webhook/BOT_TOKEN(去掉数字）",
    "has_custom_certificate": false,
    "pending_update_count": 0,
    "max_connections": 40,
    "allowed_updates": ["message", "channel_post", "edited_message", "edited_channel_post"]
  }
}
```

### 查看 Worker 日志

```bash
wrangler tail

# 发送文件后应该看到：
# ✅ 已自动保存文件: @myblog/285 (document.pdf)
```

## 🎯 支持的更新类型

Webhook 会监听以下类型的消息：

- ✅ `message` - 群组/私聊消息
- ✅ `channel_post` - 频道消息
- ✅ `edited_message` - 编辑的消息
- ✅ `edited_channel_post` - 编辑的频道消息

## 🎁 优势对比

| 功能 | 旧方案（转发） | 新方案（Webhook） |
|------|---------------|------------------|
| 需要转发消息 | ❌ 是（会留痕迹） | ✅ 否（完全静默） |
| 实时保存 | ❌ 访问时才处理 | ✅ 发送即保存 |
| 支持历史文件 | ✅ 是 | ⚠️ 需手动处理 |
| 性能 | ⚠️ 首次访问慢 | ✅ 访问极快 |
| 用户体验 | ⚠️ 可能看到转发 | ✅ 完全无感知 |

## ⚠️ 注意事项

### 1. Bot 必须是管理员

确保 Bot 在所有需要监听的频道/群组都是管理员。

### 2. Webhook 只监听新消息

设置 Webhook 后，只会保存**新发送**的文件消息。

**历史消息处理：**
- 方式 1：批量调用 `/add-forwarded-file` API
- 方式 2：在频道重新转发一次（Bot 会自动保存）

### 3. 环境变量必须正确

```bash
# 检查环境变量
wrangler secret list

# 应该有：
# ACCESS_PASSWORD
# ENCRYPTION_KEY  
# BOT_TOKEN
```

### 4. Webhook URL 必须是 HTTPS

Cloudflare Workers 默认就是 HTTPS，无需额外配置。

## 🛠️ 故障排查

### 问题 1：Webhook 设置失败

```json
{
  "error": "Webhook 设置失败",
  "detail": "Bad Request: bad webhook: HTTPS url must be provided"
}
```

**解决方法：** 确保 Worker URL 是 HTTPS（Cloudflare Workers 默认支持）

### 问题 2：访问链接返回 404

```json
{
  "error": "文件信息未找到",
  "message": "该消息的文件信息尚未保存到数据库"
}
```

**可能原因：**
- Webhook 未设置
- 消息发送在 Webhook 设置之前
- Bot 不是该频道的管理员

**解决方法：** 
1. 检查 Webhook 状态
2. 对历史消息使用 `/add-forwarded-file` API

### 问题 3：Bot 没有收到更新

```bash
# 检查 Webhook 信息
curl "https://api.telegram.org/bot你的TOKEN/getWebhookInfo"

# 查看 pending_update_count
# 如果一直增长，说明 Webhook 处理有问题
```

**解决方法：** 查看 Worker 日志排查错误

## 🚀 批量处理历史文件

```python
#!/usr/bin/env python3
import requests

WORKER_URL = "https://tgbotapi.gongzhonghao.dpdns.org"
PASSWORD = "密码"
CHAT_ID = "-1001826585339"

print("批量处理 Webhook 设置前的历史消息...")

for msg_id in range(1, 281):  # 假设消息 1-280 是历史消息
    try:
        response = requests.post(
            f"{WORKER_URL}/add-forwarded-file",
            headers={
                "Content-Type": "application/json",
                "X-Access-Password": PASSWORD
            },
            json={
                "chat_id": CHAT_ID,
                "message_id": msg_id
            },
            timeout=10
        )
        
        result = response.json()
        if result.get("success"):
            print(f"✅ {msg_id}: {result['cdn']['filename']}")
        else:
            print(f"⏭️ {msg_id}: 跳过")
    except Exception as e:
        print(f"❌ {msg_id}: {e}")

print("\n✅ 历史消息处理完成！")
print("之后的新消息会通过 Webhook 自动保存。")
```

## 📊 完整时间线

```
T-1 天: 频道有 280 条历史消息（含文件）
  ↓
T0: 设置 Webhook
  ↓ 运行批量脚本处理历史消息（1-280）
  ↓
T+1 小时: 用户上传新文件（消息 281）
  ↓ Bot 自动接收 Webhook
  ↓ 自动保存到 D1
  ↓
T+2 小时: 用户访问 /file/1826585339/281
  ↓ 从 D1 直接读取
  ↓
✅ 立即下载！
```

---

**现在你的 Bot 会全自动工作！** 🎉