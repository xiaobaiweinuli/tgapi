# 🚀 直接链接使用指南

## ✨ 核心功能

**只要知道消息 ID，直接构建链接就能下载文件！无需预先调用 API！**

## 📋 前置条件

1. ✅ Bot 是频道/群组的**管理员**
2. ✅ 已在 Cloudflare 设置 `BOT_TOKEN` 环境变量
3. ✅ 知道**消息 ID**

## 🎯 使用方法

### 场景 1：公开频道

**频道信息：**
- 频道用户名：`@myblog`
- 消息 ID：`279`

**直接访问：**
```
https://tgapi.your-subdomain.workers.dev/file/@myblog/279
```

**就这么简单！** 浏览器会自动下载文件。

### 场景 2：私有频道

**频道信息：**
- 频道 ID：`-1001826585339`
- 消息 ID：`279`

**构建链接：**
```
去掉 -100 前缀 → 1826585339
链接：https://tgapi.your-subdomain.workers.dev/file/1826585339/279
```

### 场景 3：超级群组

**群组信息：**
- 群组 ID：`-1001696541034`
- 消息 ID：`279`

**构建链接：**
```
去掉 -100 前缀 → 1696541034
链接：https://tgapi.your-subdomain.workers.dev/file/1696541034/279
```

### 场景 4：超级群组话题

**注意：** 话题链接暂时需要先调用 API 生成，因为 URL 中无法传递 `message_thread_id`。

**临时方案：** 先调用 API 生成链接，之后可以直接使用。

## 🔍 如何获取消息 ID

### 方法 1：复制消息链接（最简单）

1. 在 Telegram 桌面版/网页版右键点击消息
2. 选择 "复制消息链接"
3. 链接格式：
   - 公开频道：`https://t.me/myblog/279` → 消息 ID = `279`
   - 私有频道：`https://t.me/c/1826585339/279` → 消息 ID = `279`

### 方法 2：查看消息详情

在 Telegram 中点击消息，查看消息编号。

### 方法 3：使用 Bot API

```bash
# 获取最新消息
curl "https://api.telegram.org/bot你的TOKEN/getUpdates"

# 在返回的 JSON 中查找 message_id
```

## 📊 工作流程对比

### 传统方式（两步）

```
步骤1: 调用 API 生成链接
curl -X POST '.../add-forwarded-file' ...

步骤2: 访问返回的链接
https://.../file/1826585339/279
```

### 新方式（一步）⭐

```
直接访问：
https://.../file/1826585339/279

（首次访问会自动获取文件信息并缓存）
```

## 🚀 实际应用示例

### 示例 1：博客引用图片

```markdown
<!-- 知道图片在频道的消息 ID 是 279，直接写链接 -->
![我的图片](https://tgapi.your-subdomain.workers.dev/file/@myblog/279)
```

### 示例 2：分享文件链接

```
有人问："能分享一下那个文档吗？"

你："https://tgapi.your-subdomain.workers.dev/file/1826585339/280"

（无需任何准备，直接发链接！）
```

### 示例 3：制作文件索引页

```html
<!DOCTYPE html>
<html>
<head>
  <title>我的文件库</title>
</head>
<body>
  <h1>文档列表</h1>
  <ul>
    <!-- 只需要知道消息 ID，直接写链接 -->
    <li><a href="https://tgapi.your-subdomain.workers.dev/file/@myblog/100">文档1.pdf</a></li>
    <li><a href="https://tgapi.your-subdomain.workers.dev/file/@myblog/101">文档2.pdf</a></li>
    <li><a href="https://tgapi.your-subdomain.workers.dev/file/@myblog/102">文档3.pdf</a></li>
  </ul>
</body>
</html>
```

### 示例 4：批量生成下载链接列表

```python
#!/usr/bin/env python3

CHANNEL = "@myblog"
BASE_URL = "https://tgapi.your-subdomain.workers.dev"

# 消息 ID 100-200 的所有文件
message_ids = range(100, 201)

print("# 文件下载链接列表\n")
for msg_id in message_ids:
    link = f"{BASE_URL}/file/{CHANNEL}/{msg_id}"
    print(f"- [文件 {msg_id}]({link})")
```

## ⚙️ 技术细节

### 首次访问流程

```
1. 用户访问: https://.../file/1826585339/279
   ↓
2. Worker 检查 D1 数据库
   ↓ (未找到)
3. 自动调用 Telegram Bot API:
   - forwardMessage (获取文件详情)
   - 提取 file_id
   - deleteMessage (清理)
   - getFile (获取下载路径)
   ↓
4. 加密存储到 D1
   ↓
5. 返回文件给用户
```

### 后续访问流程

```
1. 用户访问: https://.../file/1826585339/279
   ↓
2. Worker 检查 D1 数据库
   ↓ (已缓存)
3. 直接返回文件
   
(速度更快！)
```

## 🔒 安全性

- ✅ Bot Token 加密存储在环境变量中
- ✅ 文件信息加密存储在 D1 数据库
- ✅ 下载链接不包含明文 Token
- ✅ Bot 自动清理临时转发消息

## ⚠️ 注意事项

### 1. Bot 必须是管理员

如果 Bot 不是管理员，访问链接会返回：

```json
{
  "error": "文件不存在",
  "message": "找不到该文件",
  "hint": "请确保：1) Bot 是管理员 2) 消息ID正确 3) 已设置 BOT_TOKEN 环境变量"
}
```

### 2. 必须设置 BOT_TOKEN

在 Cloudflare Dashboard 设置环境变量：
- 变量名：`BOT_TOKEN`
- 值：`123456:ABC-DEF`（不含 `bot` 前缀）
- 类型：Secret（加密）

### 3. 消息必须包含文件

如果消息是纯文本，会返回错误。支持的文件类型：
- 文档 (document)
- 图片 (photo)
- 视频 (video)
- 音频 (audio)
- 动画 (animation)
- 语音 (voice)
- 视频消息 (video_note)
- 贴纸 (sticker)

## 🎁 额外功能

### 自动缓存

首次访问后，文件信息会缓存到 D1：
- ✅ 后续访问速度更快
- ✅ 即使 Bot 退出频道，链接依然有效
- ✅ 链接永久有效

### 支持所有链接格式

```bash
# 格式 1：公开频道
https://.../file/@myblog/279

# 格式 2：私有频道（去掉 -100）
https://.../file/1826585339/279

# 格式 3：加密链接（通过 API 生成）
https://.../file/AbC123XyZ...
```

## 🚀 快速测试

```bash
# 1. 在你的频道发一条文件消息
# 2. 复制消息链接: https://t.me/c/1826585339/279
# 3. 提取消息 ID: 279
# 4. 构建下载链接:
https://tgapi.your-subdomain.workers.dev/file/1826585339/279

# 5. 在浏览器访问，自动下载！✅
```

## 💡 最佳实践

1. **公开分享**：使用友好的 `/file/@channel/id` 格式
2. **批量处理**：直接生成链接列表，无需预先调用 API
3. **静态网站**：直接在 HTML 中硬编码链接
4. **博客图床**：Markdown 中直接使用链接

---

**现在你的 Telegram 就是一个真正的 CDN！** 🎉